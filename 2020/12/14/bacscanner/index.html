<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="一个信息安全从业者的博客"><meta name="keywords" content="信息安全, 网络安全, 黑客, 渗透测试, Linux安全运维, 安全开发, python"><title>越权扫描器碎碎念 | pirogue</title><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">越权扫描器碎碎念</h1><a id="logo" href="/.">pirogue</a><p class="description">你曾听过一个地方，到达之时我们将拥有一切吗？</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入关键字..."></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">越权扫描器碎碎念</h1><div class="post-meta"><a href="/2020/12/14/bacscanner/#comments" class="comment-count"></a><p><span class="date">Dec 14, 2020</span><span><a href="/categories/安全建设/" class="category">安全建设</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h2 id="碎碎念"><a href="#碎碎念" class="headerlink" title="碎碎念"></a>碎碎念</h2><p>距离写这个小轮子已经过去半年多了，希望记录下来作为自己路上的一个沉淀，在行业里有人再次提起“越权扫描器”时能有一个从前端到后端、从代理到消费、从设计到使用的感性参考。</p>
<h2 id="为什么要做这个东西？"><a href="#为什么要做这个东西？" class="headerlink" title="为什么要做这个东西？"></a>为什么要做这个东西？</h2><ol>
<li><p>因为个人认为IAST、DAST方向的安全产品主要解决了OWASP Top 10中传统的具备可规则化的安全漏洞，比如sql注入、xss、rce等；而越权漏洞本质上可以归结为“逻辑”漏洞，逻辑类型的漏洞想要通过传统的扫描器捕获，从技术原理上来说是比较难的。比如一个功能从提出需求、评审到研发、测试、上线，每个人对它的理解都是不同的，可能研发三天不看这个代码都会忘记这个功能具体做了什么事情，指望一个不具备“智慧”大脑的扫描器理解它，并找到漏洞更是不可能的，甚至这个产品功能本身就是一个逻辑错误（类似于伪需求）。</p>
</li>
<li><p>在成熟的互联网企业，统一的公共服务，标准的研发规范，成熟的自动化流水线，再加上代码框架正逐渐步入内生安全，这一切使得传统的Web应用安全漏洞在可视范围内会越来越少。而越权漏洞可能因为研发忘记对某个参数做逻辑或归属校验，漏洞发生的限制条件很低，而造成的危害可能是极大的。</p>
</li>
</ol>
<p>通俗点讲就是自动化难检测、易发生、高危害，但我们可以力所能及自动化一部分“水平”或“垂直”越权漏洞。</p>
<h2 id="产品设计"><a href="#产品设计" class="headerlink" title="产品设计"></a>产品设计</h2><p><img src="/2020/12/14/bacscanner/bacscanner.jpeg" alt="bacscanner"><br><img src="/2020/12/14/bacscanner/art.jpg" alt="bacscanner"><br><img src="/2020/12/14/bacscanner/design.jpg" alt="bacscanner"></p>
<h2 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h2><p>谈到自动化，就少不了数据源的自动获取，比较常见的形式就是代理作为日志的生产者。市面上这么多类型的代理我们应该选择哪种既能满足高性能又能满足https的请求、响应体的全部呢？</p>
<h4 id="MitmProxy"><a href="#MitmProxy" class="headerlink" title="MitmProxy"></a>MitmProxy</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> mitmproxy.http</span><br><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx, http</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyScan</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">request</span><span class="params">(self, flow: mitmproxy.http.HTTPFlow)</span>-&gt; <span class="keyword">None</span>:</span></span><br><span class="line">        print(<span class="string">'--------------------'</span>)</span><br><span class="line">        print(flow.request.host)</span><br><span class="line">        print(flow.request.url)</span><br><span class="line">        print(flow.request.headers)</span><br><span class="line">        print(flow.request.get_text())</span><br><span class="line">        print(flow.request.get_content())</span><br><span class="line">        print(flow.request.raw_content)</span><br><span class="line">        <span class="comment"># print(flow.request.path_components)</span></span><br><span class="line">        print(<span class="string">'--------------------'</span>)</span><br><span class="line"></span><br><span class="line">addons = [</span><br><span class="line">    ProxyScan()</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>mitmproxy4是官方维护的最新版本(调研时间2019年)，重构过后的新版本不再向下兼容，更稳定，并发更高。</p>
<p>但在测试过程中，发现通过burpsuite代理mitmproxy开启200线程并发发包，再通过mitmproxy进行代理浏览网页就会发现打开网页速度变慢。</p>
<h4 id="Openresty"><a href="#Openresty" class="headerlink" title="Openresty"></a>Openresty</h4><p>跟同行(b5mali4)小明哥交流过程中，他当初落地实践的是openresty代理方案。</p>
<p>经测试发现，openresty并发非常高，在跟mitmproxy同样的测试条件下，再通过openresty进行代理浏览网页非常流畅。</p>
<h4 id="Goproxy"><a href="#Goproxy" class="headerlink" title="Goproxy"></a>Goproxy</h4><p>Goproxy地址：<a href="https://github.com/goproxy/goproxy" target="_blank" rel="noopener">https://github.com/goproxy/goproxy</a></p>
<p>在学习时找到了猪猪侠3年前写的代理工具：<a href="https://github.com/ring04h/wyproxy2，" target="_blank" rel="noopener">https://github.com/ring04h/wyproxy2，</a> 基本上把所需的功能已经都已经实现，只不过它是入库mysql，我们需要将解析后的数据打进“消息队列”。</p>
<p>在接公司的Mafka消息队列时顺便修正了代码上的一些小问题：</p>
<blockquote>
<p>在Go 1.6之前， 内置的map类型是部分goroutine安全的，并发的读没有问题，并发的写可能有问题。自go 1.6之后， 并发地读写map会报错，这在一些知名的开源库中都存在这个问题，所以go 1.9之前的解决方案是额外绑定一个锁，封装成一个新的struct或者单独使用锁都可以。<br>但是到了Go1.9发布，它有了一个新的特性，那就是sync.Map，它是原生支持并发安全的map，不过它的用法和以前我们熟悉的map完全不一样，主要还是因为sync.map封装了更为复杂的数据结构，以实现比之前加锁map更优秀的性能。</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"bytes"</span></span><br><span class="line">	<span class="string">"encoding/json"</span></span><br><span class="line">	<span class="string">"flag"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"github.com/elazarl/goproxy"</span></span><br><span class="line">	<span class="string">"io/ioutil"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">	<span class="string">"regexp"</span></span><br><span class="line">	<span class="string">"strconv"</span></span><br><span class="line">	<span class="string">"strings"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	<span class="comment">// request.Body temp var</span></span><br><span class="line">	<span class="comment">// RequestBodyMap = make(map[int64][]byte)</span></span><br><span class="line">	RequestBodyMap sync.Map</span><br><span class="line"></span><br><span class="line">	<span class="comment">// http static resource file extension</span></span><br><span class="line">	static_ext []<span class="keyword">string</span> = []<span class="keyword">string</span>&#123;</span><br><span class="line">		<span class="string">"js"</span>,</span><br><span class="line">		<span class="string">"css"</span>,</span><br><span class="line">		<span class="string">"ico"</span>,</span><br><span class="line">		<span class="string">"woff"</span>,</span><br><span class="line">		<span class="string">"ttf"</span>,</span><br><span class="line">		<span class="string">"map"</span>,</span><br><span class="line">		<span class="string">"woff2"</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// media resource files type</span></span><br><span class="line">	media_types []<span class="keyword">string</span> = []<span class="keyword">string</span>&#123;</span><br><span class="line">		<span class="string">"image"</span>,</span><br><span class="line">		<span class="string">"video"</span>,</span><br><span class="line">		<span class="string">"audio"</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// http static resource files</span></span><br><span class="line">	static_types []<span class="keyword">string</span> = []<span class="keyword">string</span>&#123;</span><br><span class="line">		<span class="string">"application/vnd.google.octet-stream-compressible"</span>,</span><br><span class="line">		<span class="string">"font/woff"</span>,</span><br><span class="line">		<span class="string">"font/woff2"</span>,</span><br><span class="line">		<span class="string">"text/css"</span>,</span><br><span class="line">		<span class="string">"text/javascript"</span>,</span><br><span class="line">		<span class="string">"baiduApp/json"</span>,</span><br><span class="line">		<span class="string">"application/javascript"</span>,</span><br><span class="line">		<span class="string">"application/x-javascript"</span>,</span><br><span class="line">		<span class="string">"application/msword"</span>,</span><br><span class="line">		<span class="string">"application/vnd.ms-excel"</span>,</span><br><span class="line">		<span class="string">"application/vnd.ms-powerpoint"</span>,</span><br><span class="line">		<span class="string">"application/x-ms-wmd"</span>,</span><br><span class="line">		<span class="string">"application/x-shockwave-flash"</span>,</span><br><span class="line">	&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkErr</span><span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Response <span class="keyword">struct</span> &#123;</span><br><span class="line">	Origin         <span class="keyword">string</span>      <span class="string">`json:"origin"`</span></span><br><span class="line">	Method         <span class="keyword">string</span>      <span class="string">`json:"method"`</span></span><br><span class="line">	Status         <span class="keyword">int</span>         <span class="string">`json:"status"`</span></span><br><span class="line">	ContentType    <span class="keyword">string</span>      <span class="string">`json:"content_type"`</span></span><br><span class="line">	ContentLength  <span class="keyword">uint</span>        <span class="string">`json:"content_length"`</span></span><br><span class="line">	Host           <span class="keyword">string</span>      <span class="string">`json:"host"`</span></span><br><span class="line">	Port           <span class="keyword">string</span>      <span class="string">`json:"port"`</span></span><br><span class="line">	URL            <span class="keyword">string</span>      <span class="string">`json:"url"`</span></span><br><span class="line">	Scheme         <span class="keyword">string</span>      <span class="string">`json:"scheme"`</span></span><br><span class="line">	Path           <span class="keyword">string</span>      <span class="string">`json:"path"`</span></span><br><span class="line">	Extension      <span class="keyword">string</span>      <span class="string">`json:"ext"`</span></span><br><span class="line">	ResponseHeader http.Header <span class="string">`json:"response_header,omitempty"`</span></span><br><span class="line">	ResponseBody   <span class="keyword">string</span>      <span class="string">`json:"response_body,omitempty"`</span></span><br><span class="line">	RequestHeader  http.Header <span class="string">`json:"request_header,omitempty"`</span></span><br><span class="line">	RequestBody    <span class="keyword">string</span>      <span class="string">`json:"request_body,omitempty"`</span></span><br><span class="line">	DateStart      time.Time   <span class="string">`json:"date_start"`</span></span><br><span class="line">	DateEnd        time.Time   <span class="string">`json:"date_end"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleRequest</span><span class="params">(req *http.Request, ctx *goproxy.ProxyCtx)</span> <span class="params">(*http.Request, *http.Response)</span></span> &#123;</span><br><span class="line">	reqbody, err := RequestBody(req)</span><br><span class="line">	checkErr(err)</span><br><span class="line">	<span class="comment">// RequestBodyMap[ctx.Session] = reqbody</span></span><br><span class="line">	RequestBodyMap.Store(ctx.Session, reqbody)</span><br><span class="line">	<span class="comment">// log.Println(req)</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> req, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//func goHandleRequest()(*http.Request, *http.Response)&#123;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RequestBody</span><span class="params">(res *http.Request)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	buf, err := ioutil.ReadAll(res.Body)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	res.Body = ioutil.NopCloser(bytes.NewReader(buf))</span><br><span class="line">	<span class="comment">// log.Printf(string(buf))</span></span><br><span class="line">	<span class="keyword">return</span> buf, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// json.Marshal方法优化，不对html做转义处理</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MarshalHTML</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> buf bytes.Buffer</span><br><span class="line">	enc := json.NewEncoder(&amp;buf)</span><br><span class="line">	enc.SetEscapeHTML(<span class="literal">false</span>)</span><br><span class="line">	err := enc.Encode(v)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> buf.Bytes(), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleResponse</span><span class="params">(resp *http.Response, ctx *goproxy.ProxyCtx)</span> *<span class="title">http</span>.<span class="title">Response</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Getting the Body</span></span><br><span class="line">	reqbody, ok := RequestBodyMap.Load(ctx.Session)</span><br><span class="line">	RequestBodyMap.Delete(ctx.Session)</span><br><span class="line">	<span class="keyword">if</span> ok != <span class="literal">false</span> &amp;&amp; resp != <span class="literal">nil</span> &#123;</span><br><span class="line">		respbody, err := ResponseBody(resp)</span><br><span class="line">		checkErr(err)</span><br><span class="line">		<span class="comment">// Attaching capture tool.</span></span><br><span class="line">		<span class="keyword">if</span> respbody != <span class="literal">nil</span> &#123;</span><br><span class="line">			RespCapture := New(resp, reqbody.([]<span class="keyword">byte</span>), respbody).Parser()</span><br><span class="line"></span><br><span class="line">			static := NewResType(</span><br><span class="line">				RespCapture.Extension,</span><br><span class="line">				RespCapture.ContentType).isStatic()</span><br><span class="line">			<span class="comment">//log.Println(RespCapture)</span></span><br><span class="line">			<span class="comment">//tmpRespCapture := RespCapture</span></span><br><span class="line">			<span class="keyword">if</span> static != <span class="literal">true</span> &#123;</span><br><span class="line">				jsonStr, err := MarshalHTML(RespCapture)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					log.Fatal()</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">//fmt.Println(jsonStr)</span></span><br><span class="line">				<span class="comment">//SynProducerCase(RespCapture)</span></span><br><span class="line">				<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">					<span class="comment">//f, err := os.OpenFile("./log/scan.log", os.O_APPEND|os.O_WRONLY|os.O_CREATE, 0666)</span></span><br><span class="line">					<span class="comment">//checkErr(err)</span></span><br><span class="line">					<span class="comment">//defer f.Close()</span></span><br><span class="line">					<span class="comment">//w := bufio.NewWriter(f)</span></span><br><span class="line">					<span class="comment">//w.WriteString(string(jsonStr))</span></span><br><span class="line">					<span class="comment">//w.Flush()</span></span><br><span class="line">					SynProducerCase(<span class="keyword">string</span>(jsonStr))</span><br><span class="line">				&#125;()</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// fmt.Printf("%s\n", jsonStr)</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> resp</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ResponseBody</span><span class="params">(res *http.Response)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> res != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> res.Body.Close()</span><br><span class="line">	&#125;</span><br><span class="line">	buf, err := ioutil.ReadAll(res.Body)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	res.Body = ioutil.NopCloser(bytes.NewReader(buf))</span><br><span class="line">	<span class="keyword">return</span> buf, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">toJsonHeader</span><span class="params">(header http.Header)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	js, err := json.Marshal(header)</span><br><span class="line">	checkErr(err)</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(js)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(resp *http.Response, reqbody []<span class="keyword">byte</span>, respbody []<span class="keyword">byte</span>)</span> *<span class="title">ParserHTTP</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;ParserHTTP&#123;r: resp, reqbody: reqbody, respbody: respbody, s: time.Now()&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewResType</span><span class="params">(ext <span class="keyword">string</span>, ctype <span class="keyword">string</span>)</span> *<span class="title">ResType</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> mtype <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">if</span> ctype != <span class="string">""</span> &#123;</span><br><span class="line">		mtype = strings.Split(ctype, <span class="string">"/"</span>)[<span class="number">0</span>]</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;ResType&#123;ext, ctype, mtype&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ParserHTTP <span class="keyword">struct</span> &#123;</span><br><span class="line">	r        *http.Response</span><br><span class="line">	reqbody  []<span class="keyword">byte</span></span><br><span class="line">	respbody []<span class="keyword">byte</span></span><br><span class="line">	s        time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ResType <span class="keyword">struct</span> &#123;</span><br><span class="line">	ext   <span class="keyword">string</span></span><br><span class="line">	ctype <span class="keyword">string</span></span><br><span class="line">	mtype <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(parser *ParserHTTP)</span> <span class="title">Parser</span><span class="params">()</span> <span class="title">Response</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		ctype   <span class="keyword">string</span></span><br><span class="line">		clength <span class="keyword">int</span></span><br><span class="line">		StrHost <span class="keyword">string</span></span><br><span class="line">		StrPort <span class="keyword">string</span></span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(parser.r.Header[<span class="string">"Content-Type"</span>]) &gt;= <span class="number">1</span> &#123;</span><br><span class="line">		ctype = GetContentType(parser.r.Header[<span class="string">"Content-Type"</span>][<span class="number">0</span>])</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(parser.r.Header[<span class="string">"Content-Length"</span>]) &gt;= <span class="number">1</span> &#123;</span><br><span class="line">		clength, _ = strconv.Atoi(parser.r.Header[<span class="string">"Content-Length"</span>][<span class="number">0</span>])</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	SliceHost := strings.Split(parser.r.Request.URL.Host, <span class="string">":"</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(SliceHost) &gt; <span class="number">1</span> &#123;</span><br><span class="line">		StrHost, StrPort = SliceHost[<span class="number">0</span>], SliceHost[<span class="number">1</span>]</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		StrHost = SliceHost[<span class="number">0</span>]</span><br><span class="line">		<span class="keyword">if</span> parser.r.Request.URL.Scheme == <span class="string">"https"</span> &#123;</span><br><span class="line">			StrPort = <span class="string">"443"</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			StrPort = <span class="string">"80"</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	now := time.Now()</span><br><span class="line"></span><br><span class="line">	r := Response&#123;</span><br><span class="line">		Origin:         parser.r.Request.RemoteAddr,</span><br><span class="line">		Method:         parser.r.Request.Method,</span><br><span class="line">		Status:         parser.r.StatusCode,</span><br><span class="line">		ContentType:    <span class="keyword">string</span>(ctype),</span><br><span class="line">		ContentLength:  <span class="keyword">uint</span>(clength),</span><br><span class="line">		Host:           StrHost,</span><br><span class="line">		Port:           StrPort,</span><br><span class="line">		URL:            parser.r.Request.URL.String(),</span><br><span class="line">		Scheme:         parser.r.Request.URL.Scheme,</span><br><span class="line">		Path:           parser.r.Request.URL.Path,</span><br><span class="line">		Extension:      GetExtension(parser.r.Request.URL.Path),</span><br><span class="line">		ResponseHeader: parser.r.Header,</span><br><span class="line">		ResponseBody:   <span class="keyword">string</span>(parser.respbody),</span><br><span class="line">		RequestHeader:  parser.r.Request.Header,</span><br><span class="line">		RequestBody:    <span class="keyword">string</span>(parser.reqbody),</span><br><span class="line">		DateStart:      parser.s,</span><br><span class="line">		DateEnd:        now,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *ResType)</span> <span class="title">isStatic</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> ContainsString(static_ext, r.ext) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> ContainsString(static_types, r.ctype) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> ContainsString(media_types, r.mtype) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetContentType</span><span class="params">(HeradeCT <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	ct := strings.Split(HeradeCT, <span class="string">"; "</span>)[<span class="number">0</span>]</span><br><span class="line">	<span class="keyword">return</span> ct</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetExtension</span><span class="params">(path <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	SlicePath := strings.Split(path, <span class="string">"."</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(SlicePath) &gt; <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> SlicePath[<span class="built_in">len</span>(SlicePath)<span class="number">-1</span>]</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ContainsString</span><span class="params">(sl []<span class="keyword">string</span>, v <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> _, vv := <span class="keyword">range</span> sl &#123;</span><br><span class="line">		<span class="keyword">if</span> vv == v &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PathExists</span><span class="params">(path <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">	_, err := os.Stat(path)</span><br><span class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> os.IsNotExist(err) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//stopper_cpu := profile.Start(profile.CPUProfile, profile.ProfilePath("."))</span></span><br><span class="line">	<span class="comment">//defer stopper_cpu.Stop()</span></span><br><span class="line">	<span class="comment">//stopper_mem := profile.Start(profile.MemProfile, profile.ProfilePath("."))</span></span><br><span class="line">	<span class="comment">//defer stopper_mem.Stop()</span></span><br><span class="line">	<span class="comment">//stopper_mutex := profile.Start(profile.MutexProfile, profile.ProfilePath("."))</span></span><br><span class="line">	<span class="comment">//defer stopper_mutex.Stop()</span></span><br><span class="line">	<span class="comment">//stopper_block := profile.Start(profile.BlockProfile, profile.ProfilePath("."))</span></span><br><span class="line">	<span class="comment">//defer stopper_block.Stop()</span></span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">"Proxy start"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 定义代理日志目录</span></span><br><span class="line">	_dir := <span class="string">"log"</span></span><br><span class="line">	exist, err := PathExists(_dir)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"get dir error![%v]\n"</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> exist &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"Proxy log dir -&gt; [%v]\n"</span>, _dir)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"No proxy log dir -&gt; [%v]\n"</span>, _dir)</span><br><span class="line">		<span class="comment">// 创建代理目录</span></span><br><span class="line">		err := os.Mkdir(_dir, os.ModePerm)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">"Mkdir proxy log failed![%v]\n"</span>, err)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">"Mkdir proxy log success!\n"</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	verbose := flag.Bool(<span class="string">"v"</span>, <span class="literal">false</span>, <span class="string">"should every proxy request be logged to stdout"</span>)</span><br><span class="line">	addr := flag.String(<span class="string">"l"</span>, <span class="string">":8080"</span>, <span class="string">"on which address should the proxy listen"</span>)</span><br><span class="line">	flag.Parse()</span><br><span class="line">	proxy := goproxy.NewProxyHttpServer()</span><br><span class="line">	proxy.Verbose = *verbose</span><br><span class="line">	log.Printf(<span class="string">"Listening %s \n"</span>, *addr)</span><br><span class="line">	log.Printf(<span class="string">"proxy Start success... \n"</span>)</span><br><span class="line">	log.Println(goproxy.ReqHostMatches())</span><br><span class="line">	proxy.OnRequest(goproxy.ReqHostMatches(regexp.MustCompile(<span class="string">`^.*\.(test|dev)\.(gongsi|yuming)\.com:443$`</span>))).HandleConnect(goproxy.AlwaysMitm)</span><br><span class="line">	proxy.OnRequest(goproxy.ReqHostMatches(regexp.MustCompile(<span class="string">`(.*\.(test|dev)\.(gongsi|yuming)\.com|10\.\d+\.\d+\.\d+)$`</span>))).DoFunc(handleRequest)</span><br><span class="line">	proxy.OnResponse().DoFunc(handleResponse)</span><br><span class="line">	log.Fatal(http.ListenAndServe(*addr, proxy))</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终选择了goproxy，因为openresty相当于用nginx+lua开发，需要打补丁对https流量进行获取，打补丁后可以获取https的host，但始终无法获取请求体等。</p>
<p>Goproxy最终效果：<br>Charles+Http；Charles+Https；Burpsuite+Http；Burpsuite+Https均可以正常代理，数据进入消息队列。</p>
<h3 id="越权扫描器"><a href="#越权扫描器" class="headerlink" title="越权扫描器"></a>越权扫描器</h3><p>生产者流量有了，剩下就是核心越权扫描器引擎。</p>
<p>思路简单来说就是“换Cookie”，即替换请求凭证，这里可能是Cookie中的token字段值、可能是header中BA认证的字段值，每个公司的情况不一。我们公司叫token，你们公司可能叫session或者sid等，甚至可能还没统一的身份认证机制，那我们替换的就是整个cookie值。</p>
<p>这相当于根据“换Cookie”请求后响应的不同来判断是否存在越权，比如原始请求的响应为“phone=170221”，替换成别人cookie后的响应为仍然为“phone=170221”，那就极可能是一个越权漏洞，这也是大家常用来测试越权漏洞的方法（或者通过遍历参数，如orderid之类）。</p>
<h4 id="详细思路"><a href="#详细思路" class="headerlink" title="详细思路"></a>详细思路</h4><p><img src="/2020/12/14/bacscanner/bacrequest.jpg" alt="bacrequest"></p>
<p>1）围绕着“换Cookie”的核心，我们将原始请求的响应叫做ResponseA，删除ssoid的响应叫做ResponseB，替换ssoid后的响应叫做ResponseC。<br>2）进一步通过删除ssoid、替换ssoid，对重新封装的请求分别发包，对3个Response的对比判断是否存在越权漏洞。<br>3）对比的方法我这里做了一个取巧的方式，通过相似度匹配，相似度定义为风险值，即相似度越高风险值也越大，越权漏洞发生的可能性越大。相似度匹配的算法使用ssdeep（ssdeep也常用于webshell检测）。</p>
<h4 id="bacLogic-go"><a href="#bacLogic-go" class="headerlink" title="bacLogic.go"></a>bacLogic.go</h4><p>我们通过代码来梳理一下具体实现逻辑，在函数bacRequest中把流量日志logPayload反序列化成[]byte的json格式的reqLog，通过reqLog.RequestHeader取出header数据，然后通过processCookie函数，用change字符串“删”或“替换”作为入参判断，对header内关键的认证字段进行改变。接着下面代码会对原始请求取reqLog.Method判断是“GET”请求，还是“POST”请求，将改变后的header、原始reqLog.URL、原始的reqLog.RequestBody重发包，这时riskBac函数会对重发包的响应 []byte(r.String())与原始响应firstResp进行对比，计算riskValue风险值（相似度）。最后通过httpLogUpdate将需要的数据插入Mysql数据库做后续的结果展示等。<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"encoding/json"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"github.com/imroc/req"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bacRequest</span><span class="params">(logPayload <span class="keyword">string</span>, change <span class="keyword">string</span>, id <span class="keyword">int64</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> reqLog Response</span><br><span class="line">	<span class="comment">//fmt.Println(string(logPayload))</span></span><br><span class="line"></span><br><span class="line">	err := json.Unmarshal([]<span class="keyword">byte</span>(logPayload), &amp;reqLog) <span class="comment">//把流量日志logPayload反序列化成[]byte的json格式的reqLog</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"json Unmarshal failed:"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//resJsonBool := strings.Contains(reqLog.ResponseHeader.Get("Content-Type"), "application/json")</span></span><br><span class="line">	header, err := processCookie(reqLog.RequestHeader, change)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(<span class="string">"处理header错误："</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	firstResp := []<span class="keyword">byte</span>(reqLog.ResponseBody) <span class="comment">// firstResp 是原始请求里的Response</span></span><br><span class="line">	<span class="keyword">if</span> reqLog.Method == <span class="string">"GET"</span> &#123;</span><br><span class="line">		r, _ := req.Get(reqLog.URL, header) <span class="comment">// Request请求开始</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//log.Println("修改请求的响应：",r.String()) //Mysql</span></span><br><span class="line">		riskValue := riskBac(firstResp, []<span class="keyword">byte</span>(r.String()))</span><br><span class="line">		<span class="comment">//log.Println("相似度的值为: ",riskValue)</span></span><br><span class="line">		reqHeader, _ := json.Marshal(r.Request().Header)</span><br><span class="line">		<span class="comment">//reqBody, err := json.Marshal(r.Request().Body) //空</span></span><br><span class="line">		respHeader, _ := json.Marshal(r.Response().Header)</span><br><span class="line">		<span class="comment">//log.Println(respHeader)</span></span><br><span class="line">		httpLogUpdate(<span class="keyword">string</span>(reqHeader), reqLog.RequestBody, <span class="keyword">string</span>(respHeader), r.String(), id, change, riskValue)</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> reqLog.Method == <span class="string">"POST"</span> &#123;</span><br><span class="line">		<span class="comment">// 1. 看Content-type，如果是json，就要用req的json方法请求；</span></span><br><span class="line">		header.Del(<span class="string">"Content-Length"</span>)</span><br><span class="line">		r, err := req.Post(reqLog.URL, header, reqLog.RequestBody)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(<span class="string">"POST请求失败："</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		riskValue := riskBac(firstResp, []<span class="keyword">byte</span>(r.String()))</span><br><span class="line"></span><br><span class="line">		reqHeader, _ := json.Marshal(r.Request().Header)</span><br><span class="line">		<span class="comment">//reqBody, err := json.Marshal(r.Request().Body) //空</span></span><br><span class="line">		respHeader, _ := json.Marshal(r.Response().Header)</span><br><span class="line"></span><br><span class="line">		httpLogUpdate(<span class="keyword">string</span>(reqHeader), reqLog.RequestBody, <span class="keyword">string</span>(respHeader), r.String(), id, change, riskValue)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> reqLog.Method == <span class="string">"OPTIONS"</span> &#123;</span><br><span class="line">		r, err := req.Options(reqLog.URL, header, reqLog.RequestBody)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(<span class="string">"OPTIONS请求失败："</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		riskValue := riskBac(firstResp, []<span class="keyword">byte</span>(r.String()))</span><br><span class="line"></span><br><span class="line">		reqHeader, _ := json.Marshal(r.Request().Header)</span><br><span class="line">		<span class="comment">//reqBody, err := json.Marshal(r.Request().Body) //空</span></span><br><span class="line">		respHeader, _ := json.Marshal(r.Response().Header)</span><br><span class="line">		httpLogUpdate(<span class="keyword">string</span>(reqHeader), reqLog.RequestBody, <span class="keyword">string</span>(respHeader), r.String(), id, change, riskValue)</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="cookie-go"><a href="#cookie-go" class="headerlink" title="cookie.go"></a>cookie.go</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"github.com/go-redis/redis"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"regexp"</span></span><br><span class="line">	<span class="string">"strings"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getSSOid</span><span class="params">(keySsoid <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="comment">// 建立redis连接</span></span><br><span class="line">	client := redis.NewClient(&amp;redis.Options&#123;</span><br><span class="line">		Addr:     appConfig.redisAddr,</span><br><span class="line">		Password: appConfig.redisPass,</span><br><span class="line">		DB:       <span class="number">1</span>,</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">defer</span> client.Close()</span><br><span class="line">	ping, err := client.Ping().Result()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(<span class="string">"Redis client connect failed ping status:"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(<span class="string">"ping status:"</span>, ping)</span><br><span class="line">	ssoid, err := client.Get(keySsoid).Result()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(<span class="string">"Get redis key value failed:"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(ssoid) &lt; <span class="number">5</span> &#123;</span><br><span class="line">		log.Println(<span class="string">"error: ssoid value length &lt; 5"</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="string">";"</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ssoid</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processCookie</span><span class="params">(headerInput http.Header, change <span class="keyword">string</span>)</span> <span class="params">(http.Header, error)</span></span> &#123;</span><br><span class="line">	header := headerInput</span><br><span class="line"></span><br><span class="line">	<span class="comment">// BA认证变更</span></span><br><span class="line">	Access_token := header.Get(<span class="string">"access-token"</span>)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(Access_token) &gt; <span class="number">10</span> &#123;</span><br><span class="line">		<span class="comment">// 删除Cookie</span></span><br><span class="line">		<span class="keyword">if</span> change == <span class="string">"del"</span> &#123;</span><br><span class="line">			<span class="comment">// 把ssoid的值全部替换为空并替换Header头中的Cookie字段</span></span><br><span class="line">			header.Set(<span class="string">"access-token"</span>, <span class="string">""</span>)</span><br><span class="line">			<span class="comment">//替换Cookie</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			newSSOid := getSSOid(change)</span><br><span class="line">			header.Set(<span class="string">"access-token"</span>, newSSOid)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Cookie := header.Get(<span class="string">"Cookie"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 通过正则取出ssoid=xxx;</span></span><br><span class="line">	reg := regexp.MustCompile(<span class="string">`[.\w]*(ssoid|SSOID|SSO_ID|sso_id|sso_sid|SSO_SID|TGCX)=[0-9a-zA-Z-_*]+`</span>)</span><br><span class="line">	<span class="comment">//log.Println(reg.FindAllString(Cookie, -1))</span></span><br><span class="line">	client_id := reg.FindAllString(Cookie, <span class="number">-1</span>)</span><br><span class="line">	<span class="comment">//log.Println(client_id)</span></span><br><span class="line">	<span class="comment">//log.Println(len(client_id))</span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(client_id) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> _, ssoid_value := <span class="keyword">range</span> client_id &#123;</span><br><span class="line">			cookieArray := strings.Split(ssoid_value, <span class="string">"="</span>) <span class="comment">//将cookie=abc;根据等号分割成数组[cookie abc]</span></span><br><span class="line">			<span class="comment">//ssoid := cookieArray[0] 			// com.hello.it.ead.cihah_ssoid</span></span><br><span class="line">			oldSsoidVal := cookieArray[<span class="number">1</span>] <span class="comment">// abc;</span></span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(oldSsoidVal) &gt; <span class="number">20</span> &#123;</span><br><span class="line">				<span class="comment">//删除Cookie</span></span><br><span class="line">				<span class="keyword">if</span> change == <span class="string">"del"</span> &#123;</span><br><span class="line">					<span class="comment">// 把ssoid的值全部替换为空并替换Header头中的Cookie字段</span></span><br><span class="line">					Cookie = strings.Replace(Cookie, oldSsoidVal, <span class="string">";"</span>, <span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">					<span class="comment">//替换Cookie</span></span><br><span class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (change == <span class="string">"ssoid-offline"</span>) || (change == <span class="string">"ssoid-online"</span>) &#123;</span><br><span class="line">					newSSOid := getSSOid(change)</span><br><span class="line">					Cookie = strings.Replace(Cookie, oldSsoidVal, newSSOid+<span class="string">";"</span>, <span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					log.Println(<span class="string">"change 标识错误"</span>)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				log.Println(<span class="string">"Cookie获取失败："</span>, cookieArray)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		header.Set(<span class="string">"Cookie"</span>, Cookie)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> header, <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="risk-go"><a href="#risk-go" class="headerlink" title="risk.go"></a>risk.go</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"github.com/glaslos/ssdeep"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//通过比较日志response和二次请求中的response相似作为越权风险值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">riskBac</span><span class="params">(firstResp []<span class="keyword">byte</span>, afterResp []<span class="keyword">byte</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(firstResp) &lt; <span class="number">30</span> || <span class="built_in">len</span>(afterResp) &lt; <span class="number">30</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">30</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	h1, err := ssdeep.FuzzyBytes(firstResp)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(<span class="string">"ssdeep h1 error:"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//log.Println(h1)</span></span><br><span class="line">	h2, err := ssdeep.FuzzyBytes(afterResp)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(<span class="string">"ssdeep h2 error:"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//log.Println(h2)</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> score <span class="keyword">int</span></span><br><span class="line">	score, err = ssdeep.Distance(h1, h2)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Println(<span class="string">"ssdeep distance failed."</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	log.Println(score)</span><br><span class="line">	<span class="keyword">return</span> score</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="“替换的cookie”来自哪里？crontab-go"><a href="#“替换的cookie”来自哪里？crontab-go" class="headerlink" title="“替换的cookie”来自哪里？crontab.go"></a>“替换的cookie”来自哪里？crontab.go</h4><p>用来做第三者的“替换cookie”也是极其重要的，它决定了在越权检测中准确性的高低。针对公司内网使用SSO进行认证的应用，我在公司申请了虚拟账号，将此账号的权限设置成最低，通过定时任务每天凌晨对认证服务进行一次请求，获取“鲜活”的cookie，用于替换和删除。</p>
<p>从下面代码可以看到每天凌晨1点，去走一次认证流程，将凭证存入redis，其中对业务进行了区分，比如SSO的应用，C端的应用生活费、助贷、分期，对C端不同业务制造出不同状态的账号。为什么要这样？我将在文章最后进行简单解释。</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"errors"</span></span><br><span class="line">	<span class="string">"github.com/go-redis/redis"</span></span><br><span class="line">	<span class="string">"github.com/imroc/req"</span></span><br><span class="line">	<span class="string">"github.com/jakecoffman/cron"</span></span><br><span class="line">	<span class="string">"io"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> cookieMT <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">//ssoOnlineURL  string</span></span><br><span class="line">	ssoOfflineURL <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> tokenMT <span class="keyword">struct</span> &#123;</span><br><span class="line">	tokenOfflineURL <span class="keyword">string</span>  <span class="comment">// 线下C端用户中心passport生成token地址</span></span><br><span class="line">	expenses <span class="keyword">string</span> <span class="comment">// 生活费，已授信，未借款 账号</span></span><br><span class="line">	diversion <span class="keyword">string</span> <span class="comment">// 已开通助贷（马上），未借款 账号</span></span><br><span class="line">	instalment <span class="keyword">string</span> <span class="comment">// 已开通分期，未借款 账号</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取线下环境ssoid的值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c cookieMT)</span> <span class="title">Runssoff</span><span class="params">()</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> resp <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">	<span class="comment">// Request请求开始</span></span><br><span class="line">	r, err := req.Get(c.ssoOfflineURL) <span class="comment">// 线下sso地址</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		Error.Println(<span class="string">"SSO Offline URL request failed:"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = r.ToJSON(&amp;resp)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		Error.Println(<span class="string">"SSO Offline URL response r.ToJSON failed:"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// interface convert to string</span></span><br><span class="line">	<span class="keyword">if</span> resp[<span class="string">"data"</span>] == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"null"</span>, errors.New(<span class="string">"获取线下ssoid为空"</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> resp[<span class="string">"data"</span>].(<span class="keyword">string</span>), <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t tokenMT)</span> <span class="title">Runtokenoff</span><span class="params">(phone <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span>&#123;</span><br><span class="line">	<span class="comment">// Request请求开始</span></span><br><span class="line">	r, err := req.Get(t.tokenOfflineURL+phone) <span class="comment">// 线下sso地址</span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		Error.Println(<span class="string">"Token Offline URL request failed:"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	resp := r.String()</span><br><span class="line">	<span class="keyword">return</span> resp, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 存线下的ssoid到reids里</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">redisSsoOff</span><span class="params">(client *redis.Client, key <span class="keyword">string</span>, ssoid <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	setStatus := client.Set(key, ssoid, <span class="number">0</span>)</span><br><span class="line">	Info.Println(<span class="string">"redis setStatus:"</span>, setStatus)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">redisTokenOff</span><span class="params">(client *redis.Client, key <span class="keyword">string</span>, ssoid <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	setStatus := client.Set(key, ssoid, <span class="number">0</span>)</span><br><span class="line">	Info.Println(<span class="string">"redis setStatus:"</span>, setStatus)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> mainCron *cron.Cron</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义日志全局变量</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	Info    *log.Logger</span><br><span class="line">	Warning *log.Logger</span><br><span class="line">	Error   *log.Logger</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志初始化配置</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	errFile, err := os.OpenFile(<span class="string">"errors.log"</span>, os.O_CREATE|os.O_WRONLY|os.O_APPEND, <span class="number">0666</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalln(<span class="string">"打开日志文件失败："</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Info = log.New(os.Stdout, <span class="string">"Info:"</span>, log.Ldate|log.Ltime|log.Lshortfile)</span><br><span class="line">	Warning = log.New(os.Stdout, <span class="string">"Warning:"</span>, log.Ldate|log.Ltime|log.Lshortfile)</span><br><span class="line">	Error = log.New(io.MultiWriter(os.Stderr, errFile), <span class="string">"Error:"</span>, log.Ldate|log.Ltime|log.Lshortfile)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">redisTask</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	cookies := cookieMT&#123;</span><br><span class="line">		<span class="comment">//ssoOnlineURL:  "http://test.com/hahaservice/get?id=pirogue&amp;password=",</span></span><br><span class="line">		ssoOfflineURL: <span class="string">"http://test.com/hahaservice/offline/get?id=pirogue&amp;password="</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	tokens := tokenMT&#123;</span><br><span class="line">		tokenOfflineURL: <span class="string">"http://gege.test.com/api/token?q="</span>,</span><br><span class="line">		expenses:        <span class="string">"15xxxxxxxxx"</span>,</span><br><span class="line">		diversion:       <span class="string">"13xxxxxxxxx"</span>,</span><br><span class="line">		instalment:      <span class="string">"13xxxxxxxxx"</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 建立redis连接</span></span><br><span class="line">	client := redis.NewClient(&amp;redis.Options&#123;</span><br><span class="line">		Addr: <span class="string">"localhost:1234"</span>,</span><br><span class="line">		Password: <span class="string">"xxxxxxxxxx"</span>,</span><br><span class="line">		DB:       <span class="number">1</span>,</span><br><span class="line">	&#125;)</span><br><span class="line">	ping, err := client.Ping().Result()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		Error.Println(<span class="string">"Redis client connect failed ping status:"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	Info.Println(<span class="string">"ping status:"</span>, ping)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">defer</span> client.Close()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 请求线上接口获取ssoid</span></span><br><span class="line">	<span class="comment">//ssoidOnline, err := cookies.Runssonline()</span></span><br><span class="line">	<span class="comment">//if err != nil &#123;</span></span><br><span class="line">	<span class="comment">//	Error.Println(err)</span></span><br><span class="line">	<span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 请求线下接口获取ssoid</span></span><br><span class="line">	ssoidOffline, err := cookies.Runssoff()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		Error.Println(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	tokenOfflineExpenses , err := tokens.Runtokenoff(tokens.expenses)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		Error.Println(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	tokenOfflineDiversion , err := tokens.Runtokenoff(tokens.diversion)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		Error.Println(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	tokenOfflineInstalment , err := tokens.Runtokenoff(tokens.instalment)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		Error.Println(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	redisSsoOff(client, <span class="string">"ssoid-offline"</span>, ssoidOffline)</span><br><span class="line">	redisTokenOff(client, <span class="string">"token-expenses"</span>, tokenOfflineExpenses)</span><br><span class="line">	redisTokenOff(client, <span class="string">"token-diversion"</span>, tokenOfflineDiversion)</span><br><span class="line">	redisTokenOff(client, <span class="string">"token-instalment"</span>, tokenOfflineInstalment)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//redisSsoOn(client, "ssoid-online", ssoidOnline)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	mainCron = cron.New()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// AddJob</span></span><br><span class="line">	tasktime := <span class="string">"0 0 1 * * ?"</span>   <span class="comment">//每天凌晨1点</span></span><br><span class="line">	<span class="comment">//tasktime := "0 0/1 * * * ? " //每2分钟</span></span><br><span class="line"></span><br><span class="line">	mainCron.AddFunc(tasktime, redisTask, <span class="string">"ssopassport"</span>)</span><br><span class="line"></span><br><span class="line">	mainCron.Start()</span><br><span class="line">	<span class="keyword">select</span> &#123;&#125; <span class="comment">//阻塞主线程不退出</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="扫描器后台"><a href="#扫描器后台" class="headerlink" title="扫描器后台"></a>扫描器后台</h2><p>扫描器后台是直接提供给用户使用的，所以产品的界面核心功能（漏洞展示）是否直观、使用是否繁琐、是否有技术门槛直接决定了这款产品最终能否能被终端客户所接受。</p>
<h3 id="为什么要提到“技术门槛”？"><a href="#为什么要提到“技术门槛”？" class="headerlink" title="为什么要提到“技术门槛”？"></a>为什么要提到“技术门槛”？</h3><p>在日常工作中，我发现不同的人对“技术门槛”的接受程度是不一样的，有人觉得“Burpsuite”门槛就十分高了。如果你的产品存在此类“技术门槛”，到最后只能成为摆设或通过外包服务的方式变相使用，最终成为自己人用的产品。</p>
<h3 id="核心功能是否直观？"><a href="#核心功能是否直观？" class="headerlink" title="核心功能是否直观？"></a>核心功能是否直观？</h3><p>在这个产品的设计过程中，核心功能就是越权漏洞的Response对比，如果能让人一眼看出哪些请求接口存在越权，那就成功了一半。但实际上我在使用的过程中虽然有“风险值”作为参考排序，通过肉眼判断对比response列表，点击列表展开仍然非常“繁琐”，甚至于接口太多导致手点的麻木了。后期为了设计一个人性化的界面，思考良久，也“偷窥”了一下行业内做的比较好的一家乙方产品，发现其类似功能也是需要点击列表进而查看漏洞比对的详情，所以这类核心功能要想最终能够较好的落地，是需要实践检验的，离不开开源交流和思想碰撞。</p>
<h3 id="Demo展示"><a href="#Demo展示" class="headerlink" title="Demo展示"></a>Demo展示</h3><p>后台代码就非常多了，后端使用gin作为Web框架，vue作为前端框架，最终我也将awvs这个主动扫描器作为被动扫描器的引擎加入到后端，包括同事用python写的扫描器轮子。</p>
<p><img src="/2020/12/14/bacscanner/createscan.jpg" alt="bacscanner"><br><img src="/2020/12/14/bacscanner/scan.jpeg" alt="bacscanner"></p>
<p>点击“创建目标”创建扫描任务，创建完成扫描目标后，点击“常规扫描”将调用awvs进行常规漏洞扫描；点击“越权扫描”对任务进行后端“替换cookie”的配置<br><img src="/2020/12/14/bacscanner/bacscan.jpeg" alt="bacscanner"></p>
<p>在弹窗的对话框中，选择是使用“SSO“的虚拟账号，还是选择”Passport“的“生活费”账号、生意贷账号等进行凭证的替换和删除。</p>
<p><img src="/2020/12/14/bacscanner/scan2.jpeg" alt="bacscanner"></p>
<p>可以看到风险值高的接口排在最上，其他字段还有host、method、url，是不是有点像web版本的burpsuite。点击蓝色的“结果”就会弹出3个Response的对比。如果这里的接口非常多，使用上将会非常麻烦，你就要点击上百次“结果”查看（今天工位的MAC触控板格外的烫手，富婆还是没有出现，我的心好累）。</p>
<p><img src="/2020/12/14/bacscanner/scan3.jpeg" alt="bacscanner"></p>
<h2 id="抛砖引玉"><a href="#抛砖引玉" class="headerlink" title="抛砖引玉"></a>抛砖引玉</h2><p>没有服务意识的网络安全爱好者不是一个好的打工人…如果想从用户体验、功能实用的角度出发设计一个好的越权扫描器显然我写的轮子是失败的，越到后面功能上的细节考虑的越多，越要贴合业务。比如用户账号这一块，从QA小姐姐那里调研才知道一个BU的业务线不同产品的用户体系也会不同，账号的授信与否决定了后面逻辑是可以请求成功。</p>
<p>畅想一下未来，也许越权扫描也会出现对应的场景规则，比如贷款类业务、打车类业务、保险类业务，比如身份证号、银行卡号、手机号，沉淀规则，打磨框架，自动化越权检测更通用和便捷。</p>
</div><div class="tags"><a href="/tags/golang/">golang</a><a href="/tags/越权/">越权</a><a href="/tags/扫描器/">扫描器</a></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2020/06/24/quant/" class="next">币圈量化交易试水</a></div><div id="comments"><script src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script><div id="comment"></div><script type="text/javascript">new Valine({
  el: '#comment',  
  notify: false, 
  verify: false, 
  app_id: 'LxlH8totxFLNwkT4nTy2ccay-gzGzoHsz',
  appKey: 'Pzf3CsqHnjhKJryLexrAy45U',
  // 评论框占位符
  placeholder: 'ヾﾉ≧∀≦)o来啊，快活啊!',  
  // 当前文章页路径，用于区分不同的文章页，以保证正确读取该文章页下的评论列表
  path:window.location.pathname,  
  // 默认头像类型
  avatar: 'wavatar',
  // 每页展示评论条数
  pageSize: 15
});</script></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#碎碎念"><span class="toc-text">碎碎念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么要做这个东西？"><span class="toc-text">为什么要做这个东西？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#产品设计"><span class="toc-text">产品设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#代理"><span class="toc-text">代理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MitmProxy"><span class="toc-text">MitmProxy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Openresty"><span class="toc-text">Openresty</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Goproxy"><span class="toc-text">Goproxy</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#越权扫描器"><span class="toc-text">越权扫描器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#详细思路"><span class="toc-text">详细思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bacLogic-go"><span class="toc-text">bacLogic.go</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cookie-go"><span class="toc-text">cookie.go</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#risk-go"><span class="toc-text">risk.go</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#“替换的cookie”来自哪里？crontab-go"><span class="toc-text">“替换的cookie”来自哪里？crontab.go</span></a></li></ol></li></ol><li class="toc-item toc-level-2"><a class="toc-link" href="#扫描器后台"><span class="toc-text">扫描器后台</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#为什么要提到“技术门槛”？"><span class="toc-text">为什么要提到“技术门槛”？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#核心功能是否直观？"><span class="toc-text">核心功能是否直观？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Demo展示"><span class="toc-text">Demo展示</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#抛砖引玉"><span class="toc-text">抛砖引玉</span></a></li></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/12/14/bacscanner/">越权扫描器碎碎念</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/06/24/quant/">币圈量化交易试水</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/02/22/golangxml/">被动扫描器研发（1）：golang生成cdata xml格式数据</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/17/awvs/">awvs（12.0.190515149）linux 安装和破解</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/15/opencanary_2/">opencanary二次开发(1)-日志格式</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/09/opencanary_1/">蜜罐正式开源-简单易用-支持16种协议</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/17/SPA/">前后端分离开发风险浅析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/14/异地恋/">异地恋</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/26/phishing/">甲方企业安全建设之钓鱼实践的一种姿势</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/20/yulong-hids/">驭龙hids入侵检测功能初探</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/安全建设/">安全建设</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全开发/">安全开发</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全运维/">安全运维</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作生活/">工作生活</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/渗透测试/">渗透测试</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/诗和远方/">诗和远方</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/量化交易/">量化交易</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/Phishing/" style="font-size: 15px;">Phishing</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/运维/" style="font-size: 15px;">运维</a> <a href="/tags/审计策略/" style="font-size: 15px;">审计策略</a> <a href="/tags/安全建设/" style="font-size: 15px;">安全建设</a> <a href="/tags/甲方安全/" style="font-size: 15px;">甲方安全</a> <a href="/tags/前后端分离/" style="font-size: 15px;">前后端分离</a> <a href="/tags/开发/" style="font-size: 15px;">开发</a> <a href="/tags/架构/" style="font-size: 15px;">架构</a> <a href="/tags/渗透测试/" style="font-size: 15px;">渗透测试</a> <a href="/tags/文件上传漏洞/" style="font-size: 15px;">文件上传漏洞</a> <a href="/tags/阿里云OSS/" style="font-size: 15px;">阿里云OSS</a> <a href="/tags/awvs/" style="font-size: 15px;">awvs</a> <a href="/tags/漏洞扫描器/" style="font-size: 15px;">漏洞扫描器</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/回调函数/" style="font-size: 15px;">回调函数</a> <a href="/tags/脏牛/" style="font-size: 15px;">脏牛</a> <a href="/tags/dirtycow/" style="font-size: 15px;">dirtycow</a> <a href="/tags/CVE-2016-5195/" style="font-size: 15px;">CVE-2016-5195</a> <a href="/tags/博客/" style="font-size: 15px;">博客</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/留言板/" style="font-size: 15px;">留言板</a> <a href="/tags/CVE-2017-7525/" style="font-size: 15px;">CVE-2017-7525</a> <a href="/tags/CVE-2017-17485/" style="font-size: 15px;">CVE-2017-17485</a> <a href="/tags/Jackson-databind反序列化漏洞/" style="font-size: 15px;">Jackson-databind反序列化漏洞</a> <a href="/tags/安全分析/" style="font-size: 15px;">安全分析</a> <a href="/tags/蜜罐/" style="font-size: 15px;">蜜罐</a> <a href="/tags/开源/" style="font-size: 15px;">开源</a> <a href="/tags/opencanary/" style="font-size: 15px;">opencanary</a> <a href="/tags/OSS对象存储/" style="font-size: 15px;">OSS对象存储</a> <a href="/tags/上传漏洞/" style="font-size: 15px;">上传漏洞</a> <a href="/tags/解析漏洞/" style="font-size: 15px;">解析漏洞</a> <a href="/tags/漏洞预警/" style="font-size: 15px;">漏洞预警</a> <a href="/tags/截屏/" style="font-size: 15px;">截屏</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/信息安全/" style="font-size: 15px;">信息安全</a> <a href="/tags/黑客/" style="font-size: 15px;">黑客</a> <a href="/tags/信息收集/" style="font-size: 15px;">信息收集</a> <a href="/tags/系统/" style="font-size: 15px;">系统</a> <a href="/tags/钓鱼/" style="font-size: 15px;">钓鱼</a> <a href="/tags/poster模块/" style="font-size: 15px;">poster模块</a> <a href="/tags/上传/" style="font-size: 15px;">上传</a> <a href="/tags/xss/" style="font-size: 15px;">xss</a> <a href="/tags/QQ邮箱/" style="font-size: 15px;">QQ邮箱</a> <a href="/tags/ssrf/" style="font-size: 15px;">ssrf</a> <a href="/tags/w3af/" style="font-size: 15px;">w3af</a> <a href="/tags/诗歌/" style="font-size: 15px;">诗歌</a> <a href="/tags/配置文件/" style="font-size: 15px;">配置文件</a> <a href="/tags/xml/" style="font-size: 15px;">xml</a> <a href="/tags/cdata/" style="font-size: 15px;">cdata</a> <a href="/tags/burpsuite/" style="font-size: 15px;">burpsuite</a> <a href="/tags/golang/" style="font-size: 15px;">golang</a> <a href="/tags/二次开发/" style="font-size: 15px;">二次开发</a> <a href="/tags/btc/" style="font-size: 15px;">btc</a> <a href="/tags/量化交易/" style="font-size: 15px;">量化交易</a> <a href="/tags/CVE-2017-10271/" style="font-size: 15px;">CVE-2017-10271</a> <a href="/tags/java反序列化/" style="font-size: 15px;">java反序列化</a> <a href="/tags/weblogic反序列化漏洞/" style="font-size: 15px;">weblogic反序列化漏洞</a> <a href="/tags/XMLDecoder反序列化漏洞/" style="font-size: 15px;">XMLDecoder反序列化漏洞</a> <a href="/tags/工作生活/" style="font-size: 15px;">工作生活</a> <a href="/tags/乙方安全/" style="font-size: 15px;">乙方安全</a> <a href="/tags/启动流程/" style="font-size: 15px;">启动流程</a> <a href="/tags/账户管理/" style="font-size: 15px;">账户管理</a> <a href="/tags/tornado/" style="font-size: 15px;">tornado</a> <a href="/tags/Web自动化攻击平台/" style="font-size: 15px;">Web自动化攻击平台</a> <a href="/tags/Apache-Commons-Collections/" style="font-size: 15px;">Apache Commons Collections</a> <a href="/tags/反弹shell/" style="font-size: 15px;">反弹shell</a> <a href="/tags/安全监控/" style="font-size: 15px;">安全监控</a> <a href="/tags/exp/" style="font-size: 15px;">exp</a> <a href="/tags/Struts2/" style="font-size: 15px;">Struts2</a> <a href="/tags/网络安全/" style="font-size: 15px;">网络安全</a> <a href="/tags/hids/" style="font-size: 15px;">hids</a> <a href="/tags/驭龙hids/" style="font-size: 15px;">驭龙hids</a> <a href="/tags/安全开发/" style="font-size: 15px;">安全开发</a> <a href="/tags/Wazuh/" style="font-size: 15px;">Wazuh</a> <a href="/tags/ELK/" style="font-size: 15px;">ELK</a> <a href="/tags/越权/" style="font-size: 15px;">越权</a> <a href="/tags/扫描器/" style="font-size: 15px;">扫描器</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://www.0x001.com/" title="0x001" target="_blank">0x001</a><ul></ul><a href="http://ksowo.com/" title="lyy" target="_blank">lyy</a><ul></ul><a href="http://xxlegend.com/" title="xxlegend" target="_blank">xxlegend</a><ul></ul><a href="https://bl4ck.in/" title="Tomato" target="_blank">Tomato</a><ul></ul><a href="https://my.oschina.net/9199771" title="超级大黑猫" target="_blank">超级大黑猫</a><ul></ul><a href="https://www.weiho.xyz/" title="Weiho" target="_blank">Weiho</a><ul></ul><a href="https://www.maliciouskr.cc/" title="MaliciousKr" target="_blank">MaliciousKr</a><ul></ul><a href="http://www.lshack.cn/" title="lsh4ck's blog" target="_blank">lsh4ck's blog</a><ul></ul><a href="https://www.0x002.com" title="Yunen's blog" target="_blank">Yunen's blog</a><ul></ul><a href="https://www.dp2px.com/" title="水寒的博客" target="_blank">水寒的博客</a><ul></ul><a href="https://www.pa55w0rd.online/" title="Pa55w0rd's blog" target="_blank">Pa55w0rd's blog</a><ul></ul><a href="http://www.mianhuage.com/" title="Cotton's Blog" target="_blank">Cotton's Blog</a><ul></ul><a href="https://zgao.top/" title="zgao" target="_blank">zgao</a><ul></ul><a href="http://lab.orchina.org/" title="糖果的实验室" target="_blank">糖果的实验室</a><ul></ul><a href="https://www.ms17010.net/" title="yd" target="_blank">yd</a><ul></ul><a href="http://blog.leanote.com/snowming" title="snowming" target="_blank">snowming</a><ul></ul><a href="https://www.cnblogs.com/ssooking" title="ssooking" target="_blank">ssooking</a><br>
<br>
『将定期清理无法访问的友情链接』</div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Sitemap</a> |  <a href="/sitemap.xml">Google Sitemap</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">pirogue.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-92976027-1','auto');ga('send','pageview');
</script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script></body></html>